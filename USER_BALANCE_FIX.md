# Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ SQL Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ´Ğ»Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²

## ğŸ”´ ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°

ĞĞ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ "ĞšÑƒĞ¿Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾ĞºĞµĞ½Ñ‹" (`https://hr.linkeon.io/buy-tokens`) Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚ÑÑ Ğ½ĞµĞ²ĞµÑ€Ğ½Ğ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°:
```
Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ·Ğ° 30 Ğ´Ğ½ĞµĞ¹: 12 505 Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²
```

**ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°:** SQL Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ² n8n workflow `HR Get User Balance` Ñ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· **Ğ½ĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹**.

## âŒ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ SQL Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ (ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹)

```sql
SELECT 
  u.id,
  u.email,
  u.name,
  COALESCE(u.tokens, 0) as tokens,
  (
    SELECT COUNT(*)
    FROM token_transactions tt          -- âŒ ĞĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ°Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°!
    WHERE tt.user_id = u.id::text
    AND tt.transaction_type = 'usage'   -- âŒ Ğ’ ÑÑ‚Ğ¾Ğ¹ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ Ğ½ĞµÑ‚ 'usage'
    AND tt.created_at >= NOW() - INTERVAL '30 days'
  ) as usage_count_30d,
  (
    SELECT COALESCE(SUM(ABS(tt.amount)), 0)
    FROM token_transactions tt          -- âŒ ĞĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ°Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°!
    WHERE tt.user_id = u.id::text
    AND tt.transaction_type = 'usage'   -- âŒ Ğ’ ÑÑ‚Ğ¾Ğ¹ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ Ğ½ĞµÑ‚ 'usage'
    AND tt.created_at >= NOW() - INTERVAL '30 days'
  ) as tokens_used_30d
FROM users u
WHERE u.id = '{{ $('Call Check JWT').item.json.user_id }}'::uuid;
```

### ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ ÑÑ‚Ğ¾ Ğ½ĞµĞ²ĞµÑ€Ğ½Ğ¾?

Ğ¡Ğ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ğ½Ğ°ÑˆĞµĞ¹ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğµ:
- âœ… **`token_transactions`** - Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ **Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğ¹** (top-ups)
  - `transaction_type = 'purchase'` Ğ¸Ğ»Ğ¸ `'topup'`
- âœ… **`token_consumption_tasks`** - Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ **Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ/Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ** Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²
  - `status = 'completed'` Ğ´Ğ»Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ‹Ñ… Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²
  - `consumed_tokens` - Ñ„Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾

## âœ… ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ SQL Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ (Ğ½Ğ¾Ğ²Ñ‹Ğ¹)

```sql
SELECT 
  u.id,
  u.email,
  u.name,
  COALESCE(u.tokens, 0) as tokens,
  (
    SELECT COUNT(*)
    FROM token_consumption_tasks tct    -- âœ… ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ°Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°
    WHERE tct.user_id = u.id::text
    AND tct.status = 'completed'        -- âœ… Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
    AND tct.created_at >= NOW() - INTERVAL '30 days'
  ) as usage_count_30d,
  (
    SELECT COALESCE(SUM(tct.consumed_tokens), 0)  -- âœ… Ğ¤Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ‹Ğµ Ñ‚Ğ¾ĞºĞµĞ½Ñ‹
    FROM token_consumption_tasks tct    -- âœ… ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ°Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°
    WHERE tct.user_id = u.id::text
    AND tct.status = 'completed'        -- âœ… Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
    AND tct.completed_at >= NOW() - INTERVAL '30 days'  -- âœ… ĞŸĞ¾ Ğ´Ğ°Ñ‚Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ
  ) as tokens_used_30d
FROM users u
WHERE u.id = '{{ $('Call Check JWT').item.json.user_id }}'::uuid;
```

## ğŸ“‹ Ğ§Ñ‚Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¾ÑÑŒ

| ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ | Ğ‘Ñ‹Ğ»Ğ¾ (âŒ) | Ğ¡Ñ‚Ğ°Ğ»Ğ¾ (âœ…) |
|----------|----------|-----------|
| **Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°** | `token_transactions` | `token_consumption_tasks` |
| **Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ñ‚Ğ¸Ğ¿Ğ°** | `transaction_type = 'usage'` | `status = 'completed'` |
| **ĞŸĞ¾Ğ´ÑÑ‡ĞµÑ‚ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²** | `SUM(ABS(tt.amount))` | `SUM(tct.consumed_tokens)` |
| **Ğ”Ğ°Ñ‚Ğ° Ğ´Ğ»Ñ tokens_used_30d** | `created_at` | `completed_at` |

## ğŸ”§ ĞšĞ°Ğº Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ

### Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ 1: ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ workflow

1. ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ n8n: `https://nomira-ai-test.up.railway.app/`
2. ĞĞ°Ğ¹Ğ´Ğ¸Ñ‚Ğµ workflow **"HR Get User Balance"**
3. ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ½Ğ¾Ğ´Ñƒ **"Get Balance"** (Postgres)
4. Ğ—Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚Ğµ SQL Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğ° Ğ½Ğ¾Ğ²Ñ‹Ğ¹ (ÑĞ¼. Ğ²Ñ‹ÑˆĞµ)
5. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚Ğµ workflow
6. ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ workflow

### Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ 2: Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ JSON

1. ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ n8n
2. Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğµ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ workflow **"HR Get User Balance"**
3. Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ»: `HR Get User Balance (1).json`
4. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ credentials Ğ´Ğ»Ñ Postgres
5. ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ workflow

## âœ… Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚

ĞŸĞ¾ÑĞ»Ğµ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ `https://hr.linkeon.io/buy-tokens` Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°Ñ‚ÑŒÑÑ **ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°**:
- **usage_count_30d** - Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ Ğ·Ğ° 30 Ğ´Ğ½ĞµĞ¹
- **tokens_used_30d** - Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ‹Ñ… Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² Ğ·Ğ° 30 Ğ´Ğ½ĞµĞ¹

## ğŸ“Š ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞĞ˜Ğ• Ğ¢ĞĞšĞ•ĞĞĞ’ (Token Consumption Flow)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ² AI Ñ‡Ğ°Ñ‚
   â†“
2. Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ÑÑ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² token_consumption_tasks
   status: 'pending'
   â†“
3. AI Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ (Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Ñ‚Ğ¾ĞºĞµĞ½Ñ‹)
   â†“
4. ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ consume_user_tokens()
   - Ğ¡Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ Ñ‚Ğ¾ĞºĞµĞ½Ñ‹ Ğ¸Ğ· users.tokens
   - ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ task: status = 'completed', consumed_tokens = N
   â†“
5. Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚ÑÑ Ğ½Ğ° /buy-tokens
   Ğ§Ğ¸Ñ‚Ğ°ĞµÑ‚ Ğ¸Ğ·: token_consumption_tasks WHERE status = 'completed'

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ĞŸĞĞŸĞĞ›ĞĞ•ĞĞ˜Ğ• Ğ¢ĞĞšĞ•ĞĞĞ’ (Token Purchase Flow)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ğ¾ĞºÑƒĞ¿Ğ°ĞµÑ‚ Ñ‚Ğ¾ĞºĞµĞ½Ñ‹ Ñ‡ĞµÑ€ĞµĞ· YooKassa
   â†“
2. Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ÑÑ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² token_transactions
   transaction_type: 'purchase', amount: +N
   â†“
3. Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ add_user_tokens()
   - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ Ñ‚Ğ¾ĞºĞµĞ½Ñ‹ Ğ² users.tokens
```

## ğŸ”— Ğ¡Ğ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹

- **Frontend:** `hrlinkeon/src/pages/BuyTokens.tsx` (ÑÑ‚Ñ€Ğ¾ĞºĞ° 182)
- **API Endpoint:** `/api/v2/user/balance`
- **n8n Workflow:** `HR Get User Balance (1).json`
- **DB Function:** `consume_user_tokens()` Ğ² `add_task_id_to_consume_tokens.sql`
- **DB Tables:**
  - `token_consumption_tasks` - Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²
  - `token_transactions` - Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²
  - `users` (ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ° `tokens`) - Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ

---

**Ğ”Ğ°Ñ‚Ğ° Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ:** 28.01.2026  
**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** âœ… Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ² `HR Get User Balance (1).json`
