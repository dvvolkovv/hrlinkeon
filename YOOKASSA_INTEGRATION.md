# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è YooKassa –¥–ª—è HR Linkeon

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–î–∞–Ω–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º HR Linkeon –ø–æ–∫—É–ø–∞—Ç—å —Ç–æ–∫–µ–Ω—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è AI-—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ —á–µ—Ä–µ–∑ –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É YooKassa.

## üóÑÔ∏è –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏:

1. **–°–æ–∑–¥–∞–Ω—ã —Ç–∞–±–ª–∏—Ü—ã:**
   - `token_packages` - –ø–∞–∫–µ—Ç—ã —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –ø–æ–∫—É–ø–∫–∏
   - `payments` - –∏—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
   - `token_transactions` - –∏—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å —Ç–æ–∫–µ–Ω–∞–º–∏

2. **–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ –≤ —Ç–∞–±–ª–∏—Ü—É `users`:**
   - `tokens` (INTEGER) - –±–∞–ª–∞–Ω—Å —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

3. **–°–æ–∑–¥–∞–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏:**
   - `add_user_tokens()` - –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
   - `deduct_user_tokens()` - —Å–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ (deprecated, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `consume_user_tokens`)
   - `get_user_token_balance()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —Ç–æ–∫–µ–Ω–æ–≤
   - `consume_user_tokens()` - —Å–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ —Å —É–º–Ω–æ–π –ª–æ–≥–∏–∫–æ–π (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

4. **–ë–∞–∑–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã —Ç–æ–∫–µ–Ω–æ–≤:**
   - **–°—Ç–∞—Ä—Ç–æ–≤—ã–π** (starter): 50,000 —Ç–æ–∫–µ–Ω–æ–≤ –∑–∞ 199‚ÇΩ
   - **–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π** (professional): 200,000 —Ç–æ–∫–µ–Ω–æ–≤ –∑–∞ 499‚ÇΩ
   - **–ë–∏–∑–Ω–µ—Å** (business): 1,000,000 —Ç–æ–∫–µ–Ω–æ–≤ –∑–∞ 1999‚ÇΩ

## üîß n8n Workflows

### 1. HR YooKassa Create Payment
**Endpoint:** `POST https://nomira-ai-test.up.railway.app/webhook/api/v2/yookassa/create-payment`
**Frontend:** `/webhook/api/v2/yookassa/create-payment`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç JWT —Ç–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. **–û–±–Ω–æ–≤–ª—è–µ—Ç email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ `users`** (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î)
3. –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–∞–∫–µ—Ç–µ —Ç–æ–∫–µ–Ω–æ–≤
4. –°–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ –≤ YooKassa —Å —É–∫–∞–∑–∞–Ω–∏–µ–º email –¥–ª—è —á–µ–∫–∞ (54-–§–ó)
5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞—Ç–µ–∂–µ –≤ –ë–î
6. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç URL –¥–ª—è –æ–ø–ª–∞—Ç—ã

**–í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```json
{
  "package_id": "starter",
  "email": "user@example.com"
}
```

**Headers:**
```
Authorization: Bearer <JWT_TOKEN>
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "payment_id": "2d84xxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "confirmation_url": "https://yoomoney.ru/checkout/payments/v2/...",
  "status": "pending"
}
```

### 2. HR YooKassa Notification Webhook
**Endpoint:** `POST https://nomira-ai-test.up.railway.app/webhook/api/v2/yookassa/notification`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç YooKassa –æ —Å—Ç–∞—Ç—É—Å–µ –ø–ª–∞—Ç–µ–∂–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π callback)

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ YooKassa:**
–í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ YooKassa –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å URL –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:
`https://nomira-ai-test.up.railway.app/webhook/api/v2/yookassa/notification`

### 3. HR YooKassa Verify Payment
**Endpoint:** `POST https://nomira-ai-test.up.railway.app/webhook/api/v2/yookassa/verify-payment`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞ (–ø–æ –∑–∞–ø—Ä–æ—Å—É —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞)

**–í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```json
{
  "payment_id": "2d84xxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
}
```

**Headers:**
```
Authorization: Bearer <JWT_TOKEN>
```

**–û—Ç–≤–µ—Ç (—É—Å–ø–µ—Ö):**
```json
{
  "status": "succeeded",
  "tokens_added": 1000,
  "new_balance": 1500,
  "transaction_id": "uuid"
}
```

## üìù –ö–∞–∫ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å workflows –≤ n8n

1. –û—Ç–∫—Ä–æ–π—Ç–µ n8n (https://nomira-ai-test.up.railway.app –∏–ª–∏ –≤–∞—à –∏–Ω—Å—Ç–∞–Ω—Å)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª **Workflows**
3. –ù–∞–∂–º–∏—Ç–µ **Import from File**
4. –í—ã–±–µ—Ä–∏—Ç–µ –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∫–∞–∂–¥—ã–π –∏–∑ —Ç—Ä–µ—Ö —Ñ–∞–π–ª–æ–≤:
   - `HR YooKassa Create Payment.json`
   - `HR YooKassa Notification Webhook.json`
   - `HR YooKassa Verify Payment.json`
5. –ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Postgres credentials (–¥–æ–ª–∂–Ω—ã —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –≤–∞—à—É –ë–î)
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ YooKassa credentials (HTTP Basic Auth —Å Shop ID –∏ Secret Key)
   - Workflow "common Check JWT" –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –∏ –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω

## üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ YooKassa

### 1. Credentials –¥–ª—è HR Linkeon:
- **Secret Key (live):** `live_SsGIMIi9bRnW021fpc0Ruc5DV_7VxIEBnIzYuXZrE60`
- **Shop ID:** (–Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ YooKassa)

‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –≠—Ç–æ **–ø—Ä–æ–¥–∞–∫—à–Ω (live)** –∫–ª—é—á! –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ test-–∫–ª—é—á.

### 2. –ì–¥–µ –Ω–∞–π—Ç–∏ Shop ID:
1. –ó–∞–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç YooKassa: https://yookassa.ru/my
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è" ‚Üí "API –∫–ª—é—á–∏"
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ **shopId** (—á–∏—Å–ª–æ–≤–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä)

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ n8n:
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Credentials** ‚Üí **Create New**
2. –í—ã–±–µ—Ä–∏—Ç–µ **HTTP Basic Auth**
3. –í–≤–µ–¥–∏—Ç–µ:
   - **User:** –≤–∞—à shopId (—á–∏—Å–ª–æ–≤–æ–π ID –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ YooKassa)
   - **Password:** `live_SsGIMIi9bRnW021fpc0Ruc5DV_7VxIEBnIzYuXZrE60`
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞–∫ "YOOKASSA"

### 4. –ü—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ credentials:
```
User: 123456
Password: live_SsGIMIi9bRnW021fpc0Ruc5DV_7VxIEBnIzYuXZrE60
```

### 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ YooKassa:
1. –í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ YooKassa –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" ‚Üí "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
2. –í–≤–µ–¥–∏—Ç–µ URL –¥–ª—è **–ø—Ä–æ–¥–∞–∫—à–Ω–∞**: `https://nomira-ai-test.up.railway.app/webhook/api/v2/yookassa/notification`
3. –î–ª—è **—Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞** –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ—Ç –∂–µ URL (n8n –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ —Ç–µ—Å—Ç–æ–≤—ã–µ, –∏ –ø—Ä–æ–¥–∞–∫—à–Ω –ø–ª–∞—Ç–µ–∂–∏)
4. –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:
   - ‚úÖ payment.succeeded (—É—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂)
   - ‚úÖ payment.canceled (–æ—Ç–º–µ–Ω–µ–Ω–Ω—ã–π –ø–ª–∞—Ç–µ–∂)
   - ‚úÖ refund.succeeded (—É—Å–ø–µ—à–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç)
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

### 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π YooKassa –æ—Ç–ø—Ä–∞–≤–∏—Ç —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:
- n8n workflow "HR YooKassa Notification Webhook" –∞–∫—Ç–∏–≤–µ–Ω
- Webhook –æ—Ç–≤–µ—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å–æ–º 200 OK

## üé® –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

#### 1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞–∫–µ—Ç–æ–≤:
```typescript
// –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç /api/v2/... (–±–∞–∑–æ–≤—ã–π URL —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç /webhook)
const packages = await apiGet('/api/v2/token-packages');
// –†–µ–∑—É–ª—å—Ç–∞—Ç: https://nomira-ai-test.up.railway.app/webhook/api/v2/token-packages
```

#### 2. –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞:
```typescript
const response = await apiPost('/api/v2/yookassa/create-payment', {
  package_id: 'starter',
  email: user.email // –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: email –¥–ª—è —á–µ–∫–∞ (54-–§–ó) –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ
});

// –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã
window.location.href = response.confirmation_url;
```

**–í–∞–∂–Ω–æ:** 
- Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º 54-–§–ó (–æ–Ω–ª–∞–π–Ω-–∫–∞—Å—Å—ã)
- Email –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ `users`
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–π email, –æ–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ –ë–î

#### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞ (–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ success):
```typescript
const paymentId = new URLSearchParams(window.location.search).get('payment_id');

const result = await apiPost('/api/v2/yookassa/verify-payment', {
  payment_id: paymentId
});

if (result.status === 'succeeded') {
  alert(`–¢–æ–∫–µ–Ω—ã –Ω–∞—á–∏—Å–ª–µ–Ω—ã! –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: ${result.new_balance}`);
}
```

**–í–∞–∂–Ω–æ:** –ë–∞–∑–æ–≤—ã–π URL –≤ `lib/api.ts` —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç `/webhook`, –ø–æ—ç—Ç–æ–º—É –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—É—Ç–∏ –≤–∏–¥–∞ `/api/v2/...`

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ —Ç–æ–∫–µ–Ω–æ–≤:
```sql
SELECT id, email, tokens FROM users WHERE email = 'test@example.com';
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:
```sql
SELECT * FROM v_user_token_history 
WHERE user_id = 'user-uuid' 
ORDER BY created_at DESC;
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π:
```sql
SELECT * FROM payments 
WHERE user_id = 'user-uuid' 
ORDER BY created_at DESC;
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
‚ö†Ô∏è **–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** —Å–æ–∑–¥–∞–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä credentials —Å **test** –∫–ª—é—á–æ–º:
1. –í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ YooKassa –≤–∫–ª—é—á–∏—Ç–µ "–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º"
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ **test shopId** –∏ **test Secret Key**
3. –°–æ–∑–¥–∞–π—Ç–µ –≤ n8n –æ—Ç–¥–µ–ª—å–Ω—ã–π credential "YOOKASSA_TEST"
4. –í workflows –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π credential

### –¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã YooKassa:
- **–£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞:** `5555 5555 5555 4477`
- **–û—Ç–∫–ª–æ–Ω–µ–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞:** `5555 5555 5555 5599`
- **3-D Secure (—É—Å–ø–µ—Ö):** `5555 5555 5555 5599` + –∫–æ–¥ `111111`
- –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: –ª—é–±–æ–π –≤ –±—É–¥—É—â–µ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, 12/25)
- CVC: –ª—é–±–æ–π —Ç—Ä–µ—Ö–∑–Ω–∞—á–Ω—ã–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, 123)
- –í–ª–∞–¥–µ–ª–µ—Ü: –ª—é–±–æ–µ –∏–º—è –ª–∞—Ç–∏–Ω–∏—Ü–µ–π

### –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É test –∏ production:
```
# –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
Credentials: YOOKASSA_TEST (test key)

# –î–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω–∞
Credentials: YOOKASSA (live key: live_SsGIMIi9bRnW021fpc0Ruc5DV_7VxIEBnIzYuXZrE60)
```

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–°–æ–∑–¥–∞—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —Å—Ç—Ä–∞–Ω–∏—Ü—É** –¥–ª—è –ø–æ–∫—É–ø–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤:
   - `/src/pages/TokenPackages.tsx` - –∫–∞—Ç–∞–ª–æ–≥ –ø–∞–∫–µ—Ç–æ–≤
   - `/src/pages/TokensSuccess.tsx` - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã

2. **–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞** —Ç–æ–∫–µ–Ω–æ–≤ –≤ —à–∞–ø–∫–µ —Å–∞–π—Ç–∞

3. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤** –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ AI-—Ñ—É–Ω–∫—Ü–∏–π:
   ```typescript
   // –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –∫ AI
   await deductUserTokens(userId, tokensUsed, 'AI –∑–∞–ø—Ä–æ—Å');
   ```

4. **–î–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ –Ω–∏–∑–∫–æ–º –±–∞–ª–∞–Ω—Å–µ —Ç–æ–∫–µ–Ω–æ–≤

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü

### token_packages
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | ID –ø–∞–∫–µ—Ç–∞ |
| code | VARCHAR(50) | –ö–æ–¥ –ø–∞–∫–µ—Ç–∞ (starter, professional, –∏ —Ç.–¥.) |
| name | VARCHAR(255) | –ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ |
| tokens | INTEGER | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ |
| price_rub | DECIMAL | –¶–µ–Ω–∞ –≤ —Ä—É–±–ª—è—Ö |
| is_active | BOOLEAN | –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ –ø–∞–∫–µ—Ç |

### payments
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | ID –∑–∞–ø–∏—Å–∏ |
| user_id | VARCHAR(255) | ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| payment_id | VARCHAR(255) | ID –ø–ª–∞—Ç–µ–∂–∞ –æ—Ç YooKassa |
| package_id | VARCHAR(50) | –ö–æ–¥ –ø–∞–∫–µ—Ç–∞ |
| amount | DECIMAL | –°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ |
| tokens | INTEGER | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ |
| status | VARCHAR(50) | –°—Ç–∞—Ç—É—Å (pending/succeeded/failed/canceled) |
| payment_url | TEXT | URL –¥–ª—è –æ–ø–ª–∞—Ç—ã |

### token_transactions
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| id | UUID | ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ |
| user_id | VARCHAR(255) | ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| amount | INTEGER | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ (+/-) |
| transaction_type | VARCHAR(50) | –¢–∏–ø (purchase/usage/refund/bonus) |
| description | TEXT | –û–ø–∏—Å–∞–Ω–∏–µ |
| metadata | JSONB | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ |

## üîß –§—É–Ω–∫—Ü–∏—è —Å–ø–∏—Å–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤

### consume_user_tokens(user_id UUID, tokens_to_consume INTEGER)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–º–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ —Å –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `user_id` (UUID) - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `tokens_to_consume` (INTEGER) - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```sql
TABLE (
  consumed_tokens INTEGER,      -- —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ —Å–ø–∏—Å–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
  remaining_balance INTEGER,     -- –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ
  transaction_id UUID            -- ID —Å–æ–∑–¥–∞–Ω–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
)
```

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**

1. **–ï—Å–ª–∏ –±–∞–ª–∞–Ω—Å = 0:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤. –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: 0`

2. **–ï—Å–ª–∏ –±–∞–ª–∞–Ω—Å >= –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤:** –°–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
   ```sql
   -- –ü—Ä–∏–º–µ—Ä: –±–∞–ª–∞–Ω—Å 1000, –∑–∞–ø—Ä–æ—Å 500
   SELECT * FROM consume_user_tokens('user-uuid', 500);
   -- –†–µ–∑—É–ª—å—Ç–∞—Ç: consumed_tokens = 500, remaining_balance = 500
   ```

3. **–ï—Å–ª–∏ –±–∞–ª–∞–Ω—Å < –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤:** –°–ø–∏—Å—ã–≤–∞–µ—Ç –æ—Å—Ç–∞—Ç–æ–∫ –¥–æ –Ω—É–ª—è
   ```sql
   -- –ü—Ä–∏–º–µ—Ä: –±–∞–ª–∞–Ω—Å 300, –∑–∞–ø—Ä–æ—Å 500
   SELECT * FROM consume_user_tokens('user-uuid', 500);
   -- –†–µ–∑—É–ª—å—Ç–∞—Ç: consumed_tokens = 300, remaining_balance = 0
   ```

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```sql
-- –°–ø–∏—Å–∞—Ç—å 1000 —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è AI-–∑–∞–ø—Ä–æ—Å–∞
SELECT * FROM consume_user_tokens(
  'a1b2c3d4-e5f6-7890-1234-567890abcdef'::UUID,
  1000
);
```

**–ó–∞—â–∏—Ç–∞ –æ—Ç race conditions:** –§—É–Ω–∫—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `SELECT ... FOR UPDATE` –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å—Ç—Ä–æ–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ `token_transactions` —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏:
- `requested_tokens` - —Å–∫–æ–ª—å–∫–æ —Ç–æ–∫–µ–Ω–æ–≤ –±—ã–ª–æ –∑–∞–ø—Ä–æ—à–µ–Ω–æ
- `consumed_tokens` - —Å–∫–æ–ª—å–∫–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ —Å–ø–∏—Å–∞–Ω–æ
- `previous_balance` - –±–∞–ª–∞–Ω—Å –¥–æ –æ–ø–µ—Ä–∞—Ü–∏–∏
- `new_balance` - –±–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –í—Å–µ endpoints –∑–∞—â–∏—â–µ–Ω—ã JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ workflow "common Check JWT"

2. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:** –§—É–Ω–∫—Ü–∏–∏ `add_user_tokens`, `deduct_user_tokens` –∏ `consume_user_tokens` –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race conditions

3. **–î–≤–æ–π–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ:** –°–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—â–µ–Ω–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞

4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `token_transactions` –¥–ª—è –∞—É–¥–∏—Ç–∞

5. **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `consume_user_tokens()` –≤–º–µ—Å—Ç–æ `deduct_user_tokens()` –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ - –æ–Ω–∞ –∏–º–µ–µ—Ç –±–æ–ª–µ–µ —É–º–Ω—É—é –ª–æ–≥–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞

## üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. –õ–æ–≥–∏ n8n workflows
2. –°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ `payments`
3. –ó–∞–ø–∏—Å–∏ –≤ `token_transactions`
4. –õ–æ–≥–∏ YooKassa –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
