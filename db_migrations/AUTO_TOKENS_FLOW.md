# üîÑ –°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤

## –û–±—â–∏–π —Ñ–ª–æ—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```mermaid
graph TD
    A[üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏] --> B[üì° POST /api/auth/register]
    B --> C{üìß Email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?}
    C -->|–î–∞| D[‚ùå –û—à–∏–±–∫–∞: EMAIL_ALREADY_REGISTERED]
    C -->|–ù–µ—Ç| E[üíæ INSERT INTO users]
    
    E --> F[‚ö° TRIGGER: BEFORE INSERT<br/>grant_initial_tokens]
    F --> G[üí∞ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å tokens = 20000]
    G --> H[‚úÖ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞ –≤ users]
    
    H --> I[‚ö° TRIGGER: AFTER INSERT<br/>log_initial_tokens_transaction]
    I --> J[üìù INSERT INTO token_transactions]
    J --> K[‚ú® –ó–∞–ø–∏—Å—å —Å —Ç–∏–ø–æ–º 'bonus' —Å–æ–∑–¥–∞–Ω–∞]
    
    K --> L[üì§ Response —Å tokens: 20000]
    L --> M[üéâ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç welcome message]
    
    style F fill:#90EE90
    style I fill:#87CEEB
    style G fill:#FFD700
    style K fill:#FFD700
    style M fill:#98FB98
```

## –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    INSERT INTO users                            ‚îÇ
‚îÇ  (email, password_hash, name, company, role)                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  üîµ BEFORE INSERT TRIGGER         ‚îÇ
         ‚îÇ  set_initial_tokens_on_user_creation ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  Function: grant_initial_tokens() ‚îÇ
         ‚îÇ                                   ‚îÇ
         ‚îÇ  IF NEW.tokens IS NULL OR 0:      ‚îÇ
         ‚îÇ    NEW.tokens := 20000            ‚îÇ
         ‚îÇ                                   ‚îÇ
         ‚îÇ  RETURN NEW;                      ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  üíæ –ó–ê–ü–ò–°–¨ –í –¢–ê–ë–õ–ò–¶–£ users        ‚îÇ
         ‚îÇ                                   ‚îÇ
         ‚îÇ  id: uuid                         ‚îÇ
         ‚îÇ  email: string                    ‚îÇ
         ‚îÇ  name: string                     ‚îÇ
         ‚îÇ  company: string                  ‚îÇ
         ‚îÇ  tokens: 20000 ‚úÖ                 ‚îÇ
         ‚îÇ  created_at: timestamp            ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  üü¢ AFTER INSERT TRIGGER                  ‚îÇ
         ‚îÇ  log_initial_tokens_on_user_creation      ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  Function: log_initial_tokens_transaction()         ‚îÇ
         ‚îÇ                                                     ‚îÇ
         ‚îÇ  INSERT INTO token_transactions (                   ‚îÇ
         ‚îÇ    user_id: NEW.id::TEXT,                          ‚îÇ
         ‚îÇ    transaction_type: 'bonus',                      ‚îÇ
         ‚îÇ    amount: 20000,                                  ‚îÇ
         ‚îÇ    balance_after: NEW.tokens,                      ‚îÇ
         ‚îÇ    description: 'Welcome bonus: initial tokens grant', ‚îÇ
         ‚îÇ    metadata: {                                     ‚îÇ
         ‚îÇ      user_email: NEW.email,                        ‚îÇ
         ‚îÇ      user_name: NEW.name,                          ‚îÇ
         ‚îÇ      company: NEW.company,                         ‚îÇ
         ‚îÇ      granted_at: NOW()                             ‚îÇ
         ‚îÇ    }                                               ‚îÇ
         ‚îÇ  )                                                 ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  üìù –ó–ê–ü–ò–°–¨ –í token_transactions   ‚îÇ
         ‚îÇ                                   ‚îÇ
         ‚îÇ  –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å —Ç–∏–ø–æ–º 'bonus'      ‚îÇ
         ‚îÇ  –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏         ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                         ‚ñº
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  ‚úÖ INSERT –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù       ‚îÇ
         ‚îÇ                                   ‚îÇ
         ‚îÇ  RETURNING:                       ‚îÇ
         ‚îÇ    id, email, name, company,      ‚îÇ
         ‚îÇ    role, tokens, created_at       ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –°—Ö–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `users`

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              users                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ id              UUID (PK)                ‚îÇ
‚îÇ email           VARCHAR(255) UNIQUE      ‚îÇ
‚îÇ password_hash   VARCHAR(255)             ‚îÇ
‚îÇ name            VARCHAR(255)             ‚îÇ
‚îÇ company         VARCHAR(255)             ‚îÇ
‚îÇ role            user_role                ‚îÇ
‚îÇ tokens          INTEGER DEFAULT 20000 ‚≠ê ‚îÇ
‚îÇ created_at      TIMESTAMP                ‚îÇ
‚îÇ updated_at      TIMESTAMP                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –¢–∞–±–ª–∏—Ü–∞ `token_transactions`

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ        token_transactions                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ id                 UUID (PK)             ‚îÇ
‚îÇ user_id            TEXT (FK ‚Üí users.id)  ‚îÇ
‚îÇ transaction_type   ENUM                  ‚îÇ
‚îÇ   ‚Ä¢ 'purchase'                           ‚îÇ
‚îÇ   ‚Ä¢ 'consumed'                           ‚îÇ
‚îÇ   ‚Ä¢ 'bonus'      ‚≠ê (–¥–ª—è welcome)        ‚îÇ
‚îÇ   ‚Ä¢ 'refund'                             ‚îÇ
‚îÇ   ‚Ä¢ 'adjustment'                         ‚îÇ
‚îÇ amount             BIGINT                ‚îÇ
‚îÇ balance_after      BIGINT                ‚îÇ
‚îÇ description        TEXT                  ‚îÇ
‚îÇ metadata           JSONB                 ‚îÇ
‚îÇ created_at         TIMESTAMP             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

### –ó–∞–ø–∏—Å—å –≤ `users`:

```sql
id:            '550e8400-e29b-41d4-a716-446655440000'
email:         'john.doe@example.com'
password_hash: '$2b$10$...'
name:          'John Doe'
company:       'Acme Corporation'
role:          'hr'
tokens:        20000  ‚≠ê
created_at:    '2026-01-29 10:30:00'
updated_at:    '2026-01-29 10:30:00'
```

### –ó–∞–ø–∏—Å—å –≤ `token_transactions`:

```sql
id:               '660f9511-f3ac-52e5-b827-557766551111'
user_id:          '550e8400-e29b-41d4-a716-446655440000'
transaction_type: 'bonus'
amount:           20000
balance_after:    20000
description:      'Welcome bonus: initial tokens grant'
metadata:         {
                    "user_email": "john.doe@example.com",
                    "user_name": "John Doe",
                    "company": "Acme Corporation",
                    "granted_at": "2026-01-29T10:30:00.123Z"
                  }
created_at:       '2026-01-29 10:30:00'
```

## –í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

```
T0: –ù–∞—á–∞–ª–æ INSERT
‚îÇ
‚îú‚îÄ T0+1ms:  –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ BEFORE INSERT trigger
‚îÇ            - grant_initial_tokens()
‚îÇ            - NEW.tokens = 20000
‚îÇ
‚îú‚îÄ T0+2ms:  –ó–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É users
‚îÇ            - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω
‚îÇ
‚îú‚îÄ T0+3ms:  –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ AFTER INSERT trigger
‚îÇ            - log_initial_tokens_transaction()
‚îÇ            - INSERT –≤ token_transactions
‚îÇ
‚îî‚îÄ T0+4ms:  –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
             - COMMIT
             - RETURNING —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–û–±—â–µ–µ –≤—Ä–µ–º—è: ~4-5ms ‚ö°
```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

```mermaid
graph TD
    A[INSERT INTO users] --> B{Email —É–Ω–∏–∫–∞–ª–µ–Ω?}
    B -->|–ù–µ—Ç| C[‚ùå UNIQUE CONSTRAINT ERROR]
    B -->|–î–∞| D[BEFORE INSERT trigger]
    
    D --> E{–¢—Ä–∏–≥–≥–µ—Ä –≤—ã–ø–æ–ª–Ω–µ–Ω?}
    E -->|–û—à–∏–±–∫–∞| F[‚ùå ROLLBACK<br/>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï —Å–æ–∑–¥–∞–Ω]
    E -->|–£—Å–ø–µ—Ö| G[–ó–∞–ø–∏—Å—å –≤ users]
    
    G --> H[AFTER INSERT trigger]
    H --> I{–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞?}
    I -->|–û—à–∏–±–∫–∞| J[‚ùå ROLLBACK<br/>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï —Å–æ–∑–¥–∞–Ω<br/>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ù–ï —Å–æ–∑–¥–∞–Ω–∞]
    I -->|–£—Å–ø–µ—Ö| K[‚úÖ COMMIT<br/>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω<br/>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞]
    
    style C fill:#FFB6C1
    style F fill:#FFB6C1
    style J fill:#FFB6C1
    style K fill:#90EE90
```

## –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              DATABASE TRANSACTION                   ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ  BEGIN;                                            ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ  1. BEFORE INSERT trigger                 ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ     - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ tokens = 20000            ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ  2. INSERT INTO users                     ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ     - –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è               ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ  3. AFTER INSERT trigger                  ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ     - INSERT INTO token_transactions      ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ  COMMIT; (–í–°–Å –ò–õ–ò –ù–ò–ß–ï–ì–û) ‚úÖ                       ‚îÇ
‚îÇ                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## API Response Flow

```
Frontend                    n8n Workflow                PostgreSQL
   ‚îÇ                             ‚îÇ                           ‚îÇ
   ‚îÇ  POST /api/auth/register    ‚îÇ                           ‚îÇ
   ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                           ‚îÇ
   ‚îÇ                             ‚îÇ  INSERT INTO users        ‚îÇ
   ‚îÇ                             ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
   ‚îÇ                             ‚îÇ                           ‚îÇ
   ‚îÇ                             ‚îÇ                  [Triggers execute]
   ‚îÇ                             ‚îÇ                           ‚îÇ
   ‚îÇ                             ‚îÇ  RETURNING id, email,     ‚îÇ
   ‚îÇ                             ‚îÇ  name, company, role,     ‚îÇ
   ‚îÇ                             ‚îÇ  tokens, created_at       ‚îÇ
   ‚îÇ                             ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
   ‚îÇ                             ‚îÇ                           ‚îÇ
   ‚îÇ  {                          ‚îÇ                           ‚îÇ
   ‚îÇ    "success": true,         ‚îÇ                           ‚îÇ
   ‚îÇ    "user_id": "...",        ‚îÇ                           ‚îÇ
   ‚îÇ    "email": "...",          ‚îÇ                           ‚îÇ
   ‚îÇ    "tokens": 20000,         ‚îÇ                           ‚îÇ
   ‚îÇ    "message": "Account      ‚îÇ                           ‚îÇ
   ‚îÇ    created successfully     ‚îÇ                           ‚îÇ
   ‚îÇ    with 20,000 welcome      ‚îÇ                           ‚îÇ
   ‚îÇ    bonus tokens!"           ‚îÇ                           ‚îÇ
   ‚îÇ  }                          ‚îÇ                           ‚îÇ
   ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                           ‚îÇ
   ‚îÇ                             ‚îÇ                           ‚îÇ
   ‚ñº                             ‚ñº                           ‚ñº
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ç–∞–∫–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

### 1. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è

```
‚ùå –°—Ç–∞—Ä—ã–π –ø–æ–¥—Ö–æ–¥:
   1. INSERT user
   2. SELECT user_id
   3. INSERT token_transaction manually
   4. UPDATE user SET tokens = 20000
   
   –ü—Ä–æ–±–ª–µ–º—ã:
   - 4 –æ–ø–µ—Ä–∞—Ü–∏–∏
   - –†–∏—Å–∫ race conditions
   - –ú–æ–∂–Ω–æ –∑–∞–±—ã—Ç—å –Ω–∞—á–∏—Å–ª–∏—Ç—å —Ç–æ–∫–µ–Ω—ã
   
‚úÖ –ù–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥:
   1. INSERT user
   
   –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
   - 1 –æ–ø–µ—Ä–∞—Ü–∏—è
   - –ê—Ç–æ–º–∞—Ä–Ω–æ
   - –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–±—ã—Ç—å
```

### 2. ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

```
–ì–∞—Ä–∞–Ω—Ç–∏–∏:
‚úì –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –í–°–ï–ì–î–ê –ø–æ–ª—É—á–∏—Ç —Ç–æ–∫–µ–Ω—ã
‚úì –ö–∞–∂–¥–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –í–°–ï–ì–î–ê –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è
‚úì –û–ø–µ—Ä–∞—Ü–∏–∏ –í–°–ï–ì–î–ê –∞—Ç–æ–º–∞—Ä–Ω—ã (–≤—Å—ë –∏–ª–∏ –Ω–∏—á–µ–≥–æ)
‚úì –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –í–°–ï–ì–î–ê –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
```

### 3. ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```javascript
// –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ:
const newUser = await db.query(`
  INSERT INTO users (email, password_hash, name, company, role)
  VALUES ($1, $2, $3, $4, 'hr')
  RETURNING *
`, [email, hash, name, company]);

// tokens —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ 20000!
// —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞!
// –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏! üéâ
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤

```sql
-- –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
SELECT trigger_name, event_manipulation, action_timing
FROM information_schema.triggers 
WHERE event_object_table = 'users';
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ welcome-–±–æ–Ω—É—Å–∞–º

```sql
-- –°–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–ª—É—á–∏–ª–∏ welcome-–±–æ–Ω—É—Å
SELECT 
    COUNT(*) as total_bonuses,
    SUM(amount) as total_tokens,
    MIN(created_at) as first_bonus,
    MAX(created_at) as last_bonus
FROM token_transactions
WHERE transaction_type = 'bonus'
  AND description = 'Welcome bonus: initial tokens grant';
```

### –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ —Ç–æ–∫–µ–Ω–æ–≤ (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å!)

```sql
-- –ê–Ω–æ–º–∞–ª–∏–∏: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–µ–∑ —Ç–æ–∫–µ–Ω–æ–≤
SELECT id, email, tokens, created_at
FROM users
WHERE tokens < 20000 OR tokens IS NULL;
-- –û–∂–∏–¥–∞–µ—Ç—Å—è: 0 –∑–∞–ø–∏—Å–µ–π
```

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `auto_grant_tokens_on_user_creation.sql` - SQL –º–∏–≥—Ä–∞—Ü–∏—è
- `AUTO_GRANT_TOKENS_README.md` - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `QUICK_START_AUTO_TOKENS.md` - –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
- `test_auto_tokens.sql` - —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
- `IMPLEMENTATION_SUMMARY_AUTO_TOKENS.md` - –∏—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞

---

**üí° –ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è:** –û–¥–∏–Ω INSERT ‚Üí –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
