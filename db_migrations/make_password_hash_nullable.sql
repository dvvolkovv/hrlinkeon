-- ============================================
-- Сделать поле password_hash необязательным
-- Дата: 2026-01-29
-- ============================================

-- Описание:
-- password_hash становится необязательным полем, что позволяет:
-- 1. Регистрацию без пароля (например, только по SMS-коду)
-- 2. Создание пользователей только с телефоном
-- 3. Последующее добавление пароля при необходимости

-- ============================================
-- Убираем NOT NULL constraint с password_hash
-- ============================================
ALTER TABLE users ALTER COLUMN password_hash DROP NOT NULL;

-- ============================================
-- Комментарий
-- ============================================
COMMENT ON COLUMN users.password_hash IS 'Хеш пароля (необязательное поле, может быть NULL для аутентификации через SMS)';

-- ============================================
-- Проверка
-- ============================================
-- Проверить структуру:
-- \d users

-- ============================================
-- Примеры использования
-- ============================================

-- Пример 1: Регистрация только по телефону (без пароля)
-- INSERT INTO users (phone)
-- VALUES ('+79001234567')
-- RETURNING id, phone, tokens, created_at;

-- Пример 2: Регистрация с паролем
-- INSERT INTO users (phone, password_hash)
-- VALUES ('+79001234567', crypt('password123', gen_salt('bf')))
-- RETURNING id, phone, tokens, created_at;

-- Пример 3: Добавление пароля существующему пользователю
-- UPDATE users 
-- SET password_hash = crypt('newpassword', gen_salt('bf'))
-- WHERE phone = '+79001234567';

-- Пример 4: Регистрация с конфликтом (обновление updated_at)
-- INSERT INTO users (phone)
-- VALUES ('+79001234567')
-- ON CONFLICT (phone) WHERE phone IS NOT NULL DO UPDATE SET
--   updated_at = CURRENT_TIMESTAMP
-- RETURNING id, phone, tokens, created_at;
